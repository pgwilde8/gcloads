{% if negotiation_cards and negotiation_cards|length > 0 %}
  {% for card in negotiation_cards %}
  <div class="bg-slate-900 border border-slate-800 p-4 rounded-xl mb-3 space-y-3">
    <div class="flex justify-between items-center">
      <div>
        <p class="text-white font-bold">{{ card.origin }} ‚Üí {{ card.destination }}</p>
        <p class="text-slate-400 text-[10px]">{{ card.equipment_type }} | {{ card.price }} | Ref: {{ card.load_ref }}</p>
      </div>
      <div class="text-right">
        <span class="text-blue-500 font-black text-xs">{{ card.status|upper }}</span>
      </div>
    </div>

    {% set call_required = card.broker_contact_preference == 'CALL' or not card.broker_email or card.is_call_required %}
    {% if call_required %}
    <div class="flex items-center gap-2 mb-2">
      <span class="bg-amber-700 text-white text-xs font-bold px-2 py-1 rounded">CALL</span>
      {% if card.broker_phone %}
        <span class="text-green-400 font-bold text-xs">{{ card.broker_phone }}</span>
      {% endif %}
      <button type="button" class="bg-green-700 hover:bg-green-600 text-white text-xs font-bold px-3 py-1 rounded transition" onclick="toggleCallPanel('{{ card.load_ref }}')">Call Broker</button>
      {% if card.last_call_outcome %}
        <span class="bg-slate-800 text-green-300 text-xs font-bold px-2 py-1 rounded ml-2">{{ card.last_call_outcome }} ¬∑ {{ card.last_call_at|timeago }}</span>
      {% endif %}
      {% if card.next_follow_up_at %}
        <span class="bg-emerald-900 text-emerald-300 text-xs font-bold px-2 py-1 rounded ml-2">Callback at {{ card.next_follow_up_at|datetime }}</span>
      {% endif %}
    </div>
    <div class="flex items-center gap-2 mb-2">
      <span class="bg-amber-700 text-white text-xs font-bold px-2 py-1 rounded">CALL</span>
      {% if card.broker_phone %}
        <span class="text-green-400 font-bold text-xs">{{ card.broker_phone }}</span>
      {% endif %}
      <button type="button" class="bg-green-700 hover:bg-green-600 text-white text-xs font-bold px-3 py-1 rounded transition" onclick="toggleCallPanel('{{ card.load_ref }}')">Call Broker</button>
    </div>
    {% include 'drivers/partials/call_panel.html' with context %}
    <script>
    function toggleCallPanel(loadRef) {
      var panel = document.getElementById('call-panel-' + loadRef);
      if (panel) panel.style.display = (panel.style.display === 'none' ? 'block' : 'none');
    }
    </script>
    {% endif %}
    {% if card.has_pending_review %}
    <div class="bg-violet-900/20 border border-violet-500/50 p-4 rounded-2xl flex justify-between items-center">
      <div class="flex items-center gap-3">
        <i class="fas fa-paper-plane text-violet-400"></i>
        <div>
          <span class="text-xs font-bold text-violet-300">AI Draft Ready{% if card.pending_review_action %}: {{ card.pending_review_action|replace('_', ' ')|upper }}{% endif %}</span>
          <p class="text-[10px] text-violet-200/80">Review gate enabled. Approve to send this draft to the broker.</p>
        </div>
      </div>
      <button type="button"
              onclick="runApproveDraft({{ card.negotiation_id }}, this)"
              class="bg-violet-600 hover:bg-violet-500 text-white text-[10px] font-black px-4 py-2 rounded-lg transition-all">
        ‚úÖ APPROVE &amp; SEND
      </button>
    </div>
    {% elif card.status == 'RATE_CON_RECEIVED' %}
    <div class="bg-blue-900/40 border-2 border-blue-500 rounded-2xl p-5 mb-4 animate-pulse">
      <div class="flex justify-between items-center">
        <div class="flex items-center gap-3">
          <i class="fas fa-file-signature text-blue-400 text-2xl"></i>
          <div>
            <h4 class="text-white font-black text-sm">RATE CON / CONTRACT RECEIVED</h4>
            <p class="text-blue-300 text-[10px] uppercase font-bold">Action Required: Review &amp; Sign Contract</p>
          </div>
        </div>
        <a href="/drivers/negotiations/{{ card.negotiation_id }}/sign"
           target="_blank"
           class="bg-blue-500 hover:bg-blue-400 text-white font-black px-6 py-2 rounded-xl shadow-lg shadow-blue-500/40 transition-all">
          ‚úçÔ∏è VIEW &amp; SIGN
        </a>
      </div>
    </div>
    {% elif card.status == 'CLOSED_PENDING_EMAIL' %}
    <div class="bg-amber-900/20 border border-amber-500/50 p-4 rounded-2xl flex justify-between items-center">
      <div class="flex items-center gap-3">
        <i class="fas fa-exclamation-triangle text-amber-500 animate-pulse"></i>
        <div>
          <span class="text-xs font-bold text-amber-500">Packet failed to send. Broker is waiting!</span>
          <p class="text-[10px] text-amber-300/90">If retry fails twice, check MXRoute SMTP logs before retrying again.</p>
        </div>
      </div>
      <button type="button"
              onclick="runRetrySecureEmail({{ card.negotiation_id }}, this)"
              class="bg-amber-600 hover:bg-amber-500 text-white text-[10px] font-black px-4 py-2 rounded-lg transition-all">
        üîÑ RETRY DISPATCH
      </button>
    </div>
    {% else %}
    <div class="bg-slate-900 border-b border-green-500/30 p-4 flex justify-between items-center rounded-xl">
      <div class="flex items-center gap-3">
        <span class="relative flex h-3 w-3">
          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
          <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
        </span>
        <span class="text-xs font-black text-green-400 uppercase">AI Negotiating...</span>
      </div>

      <div class="flex gap-2">
        <button type="button"
          onclick="runSecureLoad({{ card.negotiation_id }}, this)"
                class="bg-green-600 hover:bg-green-500 text-white text-xs font-black px-6 py-2 rounded-xl shadow-lg shadow-green-500/20 transition-all active:scale-95">
          üéØ SECURE &amp; SEND PACKET
        </button>

        <button type="button"
          onclick="runStopAiManual({{ card.negotiation_id }}, this)"
          class="bg-slate-800 hover:bg-slate-700 text-slate-400 hover:text-white text-xs font-bold px-4 py-2 rounded-xl transition">
          Stop AI (Manual Mode)
        </button>
      </div>
    </div>

    <div class="flex flex-wrap gap-2">
      <form id="broker-attachment-form-{{ card.negotiation_id }}" class="flex flex-wrap gap-2 items-center" onsubmit="event.preventDefault(); runSecureLoadWithAttachments({{ card.negotiation_id }}, this);">
        <label class="text-xs text-slate-400 font-bold mr-2">Attach:</label>
        <input type="checkbox" name="attachment_doc_types" value="BOL_PACKET" checked disabled class="mr-1"> <span class="mr-2">BOL Packet</span>
        {% if card.has_ratecon %}
        <input type="checkbox" name="attachment_doc_types" value="RATECON" class="mr-1"> <span class="mr-2">RateCon</span>
        {% endif %}
        {% if card.has_w9 %}
        <input type="checkbox" name="attachment_doc_types" value="W9" class="mr-1"> <span class="mr-2">W9</span>
        {% endif %}
        {% if card.has_coi %}
        <input type="checkbox" name="attachment_doc_types" value="INSURANCE" class="mr-1"> <span class="mr-2">COI</span>
        {% endif %}
        {% if card.has_authority %}
        <input type="checkbox" name="attachment_doc_types" value="AUTHORITY" class="mr-1"> <span class="mr-2">MC Authority</span>
        {% endif %}
        <button type="submit" class="bg-green-600 hover:bg-green-500 text-white text-xs font-black px-6 py-2 rounded-xl shadow-lg shadow-green-500/20 transition-all active:scale-95 ml-2">üéØ SECURE &amp; SEND PACKET</button>
      </form>
      <script>
      function runSecureLoadWithAttachments(negotiationId, formEl) {
        if (!negotiationId || !formEl) return;
        const checkboxes = formEl.querySelectorAll('input[type="checkbox"][name="attachment_doc_types"]');
        const selected = Array.from(checkboxes).filter(cb => cb.checked && !cb.disabled).map(cb => cb.value);
        const body = new URLSearchParams({ negotiation_id: String(negotiationId), attachment_doc_types: selected.join(',') });
        fetch('/api/negotiations/secure-load', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'Accept': 'application/json' },
          body: body.toString(),
        }).then(resp => resp.json()).then(data => {
          if (!data || data.status !== 'ok') {
            alert('Secure failed: ' + (data.message || 'secure_load_failed'));
            return;
          }
          alert('Packet sent! Attachments: ' + (data.sent_attachment_doc_types || []).join(', '));
          if (window.htmx) window.htmx.trigger(document.body, 'dashboardActiveLoadsRefresh');
        }).catch(() => alert('Secure failed: network error'));
      }
      </script>
      <button type="button"
              class="bg-blue-600 hover:bg-blue-500 text-white text-[11px] font-bold px-3 py-2 rounded-lg transition"
              onclick="runComposePacket({{ card.negotiation_id }}, this)">
        {% if card.has_bol_packet %}
        üì¶ BOL Packet Ready (Rebuild)
        {% elif card.has_bol_raw %}
        üì¶ Compose BOL Packet
        {% else %}
        üì¶ Build BOL Packet
        {% endif %}
      </button>
      <button type="button"
              class="bg-emerald-600 hover:bg-emerald-500 text-white text-[11px] font-bold px-3 py-2 rounded-lg transition"
              onclick="runQuickReply('counter', {{ card.negotiation_id }}, this)">
        üí∞ Counter +$200
      </button>
      <button type="button"
              class="bg-amber-600 hover:bg-amber-500 text-white text-[11px] font-bold px-3 py-2 rounded-lg transition"
              onclick="runQuickReply('finalize', {{ card.negotiation_id }}, this)">
        ü§ù Finalize
      </button>
    </div>
    <div class="text-[10px] text-slate-500 mt-2">
      Docs:
      <span class="{% if card.has_bol_raw %}text-emerald-400{% else %}text-slate-500{% endif %}">BOL Raw{% if card.has_bol_raw %} ‚úì{% endif %}</span>
      ¬∑
      <span class="{% if card.has_bol_packet %}text-emerald-400{% else %}text-slate-500{% endif %}">BOL Packet{% if card.has_bol_packet %} ‚úì{% endif %}</span>
    </div>
    <div id="compose-status-{{ card.negotiation_id }}" class="text-[11px] mt-2 text-slate-400"></div>
    {% endif %}
    {% else %}
    <p class="text-[11px] text-amber-400 font-semibold">No broker email found for this negotiation.</p>
    {% endif %}
  </div>
  {% endfor %}
{% else %}
  <div class="bg-slate-900 border border-slate-800 rounded-2xl p-10 text-center">
    <div class="bg-slate-800 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-slate-600">
      <i class="fas fa-radar text-2xl"></i>
    </div>
    <h4 class="text-white font-bold">Scanning for Opportunities</h4>
    <p class="text-slate-500 text-xs mt-2 max-w-xs mx-auto">
      No active negotiations yet. Scout will populate this feed as soon as new loads are ingested.
    </p>
  </div>
{% endif %}
